---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());

// Group posts by year and month
interface PostsByYearMonth {
	[year: string]: {
		[month: string]: typeof allPosts;
	};
}

const postsByYearMonth: PostsByYearMonth = {};

sortedPosts.forEach(post => {
	const date = new Date(post.data.pubDate);
	const year = date.getFullYear().toString();
	const month = date.toLocaleString('default', { month: 'long' });
	const monthNum = String(date.getMonth() + 1).padStart(2, '0');

	if (!postsByYearMonth[year]) {
		postsByYearMonth[year] = {};
	}
	if (!postsByYearMonth[year][monthNum]) {
		postsByYearMonth[year][monthNum] = [];
	}
	postsByYearMonth[year][monthNum].push(post);
});

// Get sorted years in descending order
const years = Object.keys(postsByYearMonth).sort((a, b) => Number(b) - Number(a));

// Get unique month-year combinations for sidebar
const monthYearList: Array<{ year: string; monthNum: string; monthName: string }> = [];
years.forEach(year => {
	const monthNums = Object.keys(postsByYearMonth[year]).sort().reverse();
	monthNums.forEach(monthNum => {
		const date = new Date(Number(year), Number(monthNum) - 1);
		monthYearList.push({
			year,
			monthNum,
			monthName: date.toLocaleString('default', { month: 'long' })
		});
	});
});
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main class="blog-container">
			<div class="blog-layout">
				<!-- Sidebar -->
				<aside class="blog-sidebar">
					<h3>Archive</h3>
					<div class="month-list">
						{monthYearList.map(({ year, monthNum, monthName }) => (
							<a href={`#${year}-${monthNum}`} class="month-link">
								{monthName} {year}
							</a>
						))}
					</div>
				</aside>

				<!-- Main Content -->
				<div class="blog-content">
					<h1>Weekly Insights</h1>
					<p class="blog-intro">Discover weekly insights, strategies, and perspectives on business growth and innovation.</p>

					{years.map(year => (
						<section class="year-section">
							<h2 class="year-title">{year}</h2>
							
							{Object.keys(postsByYearMonth[year])
								.sort()
								.reverse()
								.map(monthNum => {
									const date = new Date(Number(year), Number(monthNum) - 1);
									const monthName = date.toLocaleString('default', { month: 'long' });
									const posts = postsByYearMonth[year][monthNum];
									
									return (
										<section class="month-section" id={`${year}-${monthNum}`}>
											<h3 class="month-title">{monthName}</h3>
											<div class="posts-grid">
												{posts.map(post => (
													<article class="post-card">
														<div class="post-date">
															{new Date(post.data.pubDate).toLocaleDateString('en-US', {
																month: 'short',
																day: 'numeric'
															})}
														</div>
														<h4 class="post-title">
															<a href={`/blog/${post.slug}`}>{post.data.title}</a>
														</h4>
														<p class="post-description">{post.data.description}</p>
														<a href={`/blog/${post.slug}`} class="read-more">Read more â†’</a>
													</article>
												))}
											</div>
										</section>
									);
								})}
						</section>
					))}
				</div>
			</div>
		</main>
		<Footer />
	</body>
</html>

<style>
	.blog-container {
		width: 100%;
		padding: 2rem 0;
		background: rgb(var(--gray-light));
	}

	.blog-layout {
		display: grid;
		grid-template-columns: 250px 1fr;
		gap: 3rem;
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 2rem;
	}

	.blog-sidebar {
		position: sticky;
		top: 100px;
		height: fit-content;
	}

	.blog-sidebar h3 {
		font-size: 1.25em;
		margin-bottom: 1.5rem;
		color: var(--accent);
		font-weight: 700;
	}

	.month-list {
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
	}

	.month-link {
		color: var(--accent);
		text-decoration: none;
		padding: 0.5rem 0.75rem;
		border-radius: 4px;
		transition: all 0.2s ease;
		font-size: 0.95em;
		font-weight: 500;
	}

	.month-link:hover {
		background-color: rgb(var(--white));
		color: var(--accent-dark);
	}

	.blog-content {
		padding-bottom: 4rem;
	}

	.blog-content h1 {
		margin-bottom: 0.5rem;
		font-size: 2.5em;
		color: var(--accent);
		font-weight: 700;
	}

	.blog-intro {
		color: rgb(var(--gray));
		font-size: 1.1em;
		margin-bottom: 3rem;
	}

	.year-section {
		margin-bottom: 4rem;
	}

	.year-title {
		font-size: 2em;
		margin-bottom: 2rem;
		padding-bottom: 1rem;
		border-bottom: 2px solid var(--accent);
		color: var(--accent);
		font-weight: 700;
	}

	.month-section {
		margin-bottom: 3rem;
		scroll-margin-top: 100px;
	}

	.month-title {
		font-size: 1.5em;
		margin-bottom: 1.5rem;
		color: var(--accent);
		font-weight: 700;
	}

	.posts-grid {
		display: grid;
		gap: 1.5rem;
	}

	.post-card {
		padding: 1.5rem;
		border: 1px solid rgb(var(--gray-light));
		border-radius: 8px;
		transition: all 0.2s ease;
		background: rgb(var(--white));
	}

	.post-card:hover {
		border-color: var(--accent);
		box-shadow: 0 4px 12px rgba(100, 116, 139, 0.1);
		transform: translateY(-2px);
	}

	.post-date {
		font-size: 0.85em;
		color: rgb(var(--gray));
		margin-bottom: 0.5rem;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		font-weight: 600;
	}

	.post-title {
		margin: 0.5rem 0;
		font-size: 1.25em;
		font-weight: 700;
	}

	.post-title a {
		color: var(--accent);
		text-decoration: none;
		transition: color 0.2s ease;
	}

	.post-title a:hover {
		color: var(--accent-dark);
	}

	.post-description {
		color: rgb(var(--gray));
		margin: 0.75rem 0;
		line-height: 1.6;
	}

	.read-more {
		display: inline-block;
		margin-top: 1rem;
		font-weight: 600;
		color: var(--accent);
		transition: all 0.2s ease;
	}

	.read-more:hover {
		transform: translateX(4px);
		color: var(--accent-dark);
	}

	@media (max-width: 1024px) {
		.blog-layout {
			grid-template-columns: 1fr;
			gap: 2rem;
		}

		.blog-sidebar {
			position: static;
		}

		.month-list {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 0.5rem;
		}
	}

	@media (max-width: 768px) {
		.blog-layout {
			padding: 0 1rem;
		}

		.blog-content h1 {
			font-size: 1.75em;
		}

		.year-title {
			font-size: 1.5em;
		}

		.month-title {
			font-size: 1.25em;
		}

		.post-card {
			padding: 1rem;
		}
	}
</style>
